#!/usr/bin/env sh

{
    . "$(dirname $0)/common"

    install_dep() {
        dep=$1
        depscript="$(dirname $0)/deps/$dep"
        if [ ! -f $depscript ] || [ ! -x $depscript ]; then
            logerr "cannot install $dep: $depscript not found or not executable"
            exit 1
        fi

        log "checking for $dep"
        if ! $depscript check; then
            log "checking dependencies of $dep"
            for subdep in $($depscript deps); do
                log " => $dep depends on $subdep"
                unset dep
                unset depscript
                install_dep $subdep
                dep=$1
                depscript="$(dirname $0)/deps/$dep"
            done
            $depscript install
            if ! $depscript check; then
                logerr "failed to install $dep"
                exit 1
            fi
        fi
    }

    install_deps() {
        sdir=$(dirname $0)
        for depscript in $(ls $sdir/deps/*); do
            dep=$(basename $depscript)
            install_dep $dep
        done
    }

    log "checking for pkgmgr"
    pkgmgr="$(dirname $0)/pkgmgr"
    if ! $pkgmgr check; then
        if ! $pkgmgr selfinstall; then
            logexit "failed to install $($pkgmgr name) pkgmgr"
        else
            log " => successfully installed $($pkgmgr name) pkgmgr"
        fi
    fi

    install_deps

#    "$(dirname $0)/google-sso" $@
#    if [ 0 -ne $? ]; then
#        logexit "failed to log into Psocratic Google account"
#    fi

    github_auth=$("$(dirname $0)/github/auth" $@)
    if [ 0 -ne $? ]; then
        logexit "failed to log into GitHub"
    fi
}
